call mtr.add_suppression("Slave SQL: Error 'InnoDB : ENCRYPTION is not accepted syntax for CREATE/ALTER table, for tables in general/shared tablespace.'");
call mtr.add_suppression("Query apply failed.");
#node-1
use test;
CREATE TABLESPACE foo ADD DATAFILE 'foo.ibd' ENCRYPTION='Y';
create table t1 (i int, primary key pk(i)) tablespace foo encryption='y';
ERROR HY000: InnoDB : ENCRYPTION is not accepted syntax for CREATE/ALTER table, for tables in general/shared tablespace.
create table t2 (i int, primary key pk(i)) tablespace foo encryption='n';
ERROR HY000: InnoDB : ENCRYPTION is not accepted syntax for CREATE/ALTER table, for tables in general/shared tablespace.
create table t1 (i int, primary key pk(i)) tablespace foo;
insert into t1 values (1), (2), (3);
select * from t1;
i
1
2
3
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `i` int(11) NOT NULL,
  PRIMARY KEY (`i`)
) /*!50100 TABLESPACE `foo` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
#node-2
select * from t1;
i
1
2
3
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `i` int(11) NOT NULL,
  PRIMARY KEY (`i`)
) /*!50100 TABLESPACE `foo` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
create table t2 (i int, primary key pk(i)) tablespace foo;
insert into t2 values (10), (20), (30);
#node-1
show create table t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `i` int(11) NOT NULL,
  PRIMARY KEY (`i`)
) /*!50100 TABLESPACE `foo` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
drop table t1, t2;
drop tablespace foo;
#node-2 being killed
Killing server ...
#node-1
use test;
CREATE TABLESPACE foo ADD DATAFILE 'foo.ibd' ENCRYPTION='Y';
create table t1 (i int, primary key pk(i)) tablespace foo;
insert into t1 values (1), (2), (3);
select * from t1;
i
1
2
3
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `i` int(11) NOT NULL,
  PRIMARY KEY (`i`)
) /*!50100 TABLESPACE `foo` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
#node-2 restarted (should get encrypted table through SST)
# restart
call mtr.add_suppression(".*can contain only an ENCRYPTED tables.*");
select * from t1;
i
1
2
3
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `i` int(11) NOT NULL,
  PRIMARY KEY (`i`)
) /*!50100 TABLESPACE `foo` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
create table t2 (i int, primary key pk(i)) tablespace foo;
insert into t2 values (10), (20), (30);
#node-1
show create table t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `i` int(11) NOT NULL,
  PRIMARY KEY (`i`)
) /*!50100 TABLESPACE `foo` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
drop table t1, t2;
drop tablespace foo;
#node-2 being shutdown
#node-1
use test;
CREATE TABLESPACE foo ADD DATAFILE 'foo.ibd' ENCRYPTION='Y';
create table t1 (i int, primary key pk(i)) tablespace foo;
insert into t1 values (1);
select * from t1;
i
1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `i` int(11) NOT NULL,
  PRIMARY KEY (`i`)
) /*!50100 TABLESPACE `foo` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
#node-2 restarted (should get encrypted table through IST)
# restart
call mtr.add_suppression(".*can contain only an ENCRYPTED tables.*");
select * from t1;
i
1
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `i` int(11) NOT NULL,
  PRIMARY KEY (`i`)
) /*!50100 TABLESPACE `foo` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
create table t2 (i int, primary key pk(i)) tablespace foo;
insert into t2 values (10), (20), (30);
#node-1
show create table t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `i` int(11) NOT NULL,
  PRIMARY KEY (`i`)
) /*!50100 TABLESPACE `foo` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
drop table t1, t2;
drop tablespace foo;
#node-1
CREATE TABLESPACE `ts1` ADD DATAFILE 'ts1.ibd' ENCRYPTION = 'Y' Engine=InnoDB;
CREATE TABLE t1 (c1 INT) ENCRYPTION = 'Y';
#node-2
select name, flag, encryption from information_schema.innodb_tablespaces where name = "ts1" OR name = "test/t1";
name	flag	encryption
ts1	26624	Y
test/t1	24609	Y
alter table t1 tablespace ts1;
ALTER TABLESPACE ts1 ENCRYPTION = 'N';
select name, flag, encryption from information_schema.innodb_tablespaces where name = "ts1" OR name = "test/t1";
name	flag	encryption
ts1	18432	N
#node-1
select name, flag, encryption from information_schema.innodb_tablespaces where name = "ts1" OR name = "test/t1";
name	flag	encryption
ts1	18432	N
DROP TABLE t1;
DROP TABLESPACE `ts1`;
#node-2
select name, flag, encryption from information_schema.innodb_tablespaces where name = "ts1" OR name = "test/t1";
name	flag	encryption
